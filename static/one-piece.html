<!doctype html>
<html lang="de">
<head>
    <title>One Piece | Lars Junker</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="One Piece Baende: Status aus Google Sheets."/>

    <link rel="icon" href="/favicon.ico">

    <link rel="stylesheet" href="/static/style.css?v=3">
    <link rel="stylesheet" href="/static/ansi.css?v=2">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<div id="container">
    <header>
        <div w3-include-html="/nav.html"></div>
    </header>

    <main>
        <h1 class="title">one piece</h1>
        <p class="content">
            Status aus Google Sheets (Tab: "One Piece").
        </p>
        <p class="content" id="one-piece-status"></p>
        <br>

        <table id="one-piece-table" class="shadow">
            <caption>BÃ¤nde</caption>
            <thead>
            <tr>
                <th>NUMMER</th>
                <th>STATUS</th>
            </tr>
            </thead>
            <tbody id="one-piece-tbody">
            </tbody>
        </table>
    </main>

    <footer>
        <pre class="footer"><code>
&copy; Lars Junker - <script>document.write(new Date().getFullYear())</script>
        </code></pre>
    </footer>
</div>
<script>
    var SHEET_ID = '1PZFS6bBs_187W75srTyNw0Bc5ZRJGBWUEuitlc1pdXs';
    var SHEET_NAME = 'One Piece';
    var CSV_URL = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID +
        '/gviz/tq?sheet=' + encodeURIComponent(SHEET_NAME) + '&tqx=out:csv';

    function parseCSV(text) {
        var rows = [];
        var row = [];
        var cell = '';
        var inQuotes = false;

        for (var i = 0; i < text.length; i++) {
            var ch = text[i];
            var next = text[i + 1];

            if (ch === '"') {
                if (inQuotes && next === '"') {
                    cell += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
                continue;
            }

            if (!inQuotes && ch === ',') {
                row.push(cell);
                cell = '';
                continue;
            }

            if (!inQuotes && (ch === '\n' || ch === '\r')) {
                if (ch === '\r' && next === '\n') i++;
                row.push(cell);
                rows.push(row);
                row = [];
                cell = '';
                continue;
            }

            cell += ch;
        }

        if (cell.length || row.length) {
            row.push(cell);
            rows.push(row);
        }

        return rows;
    }

    function renderRows(rows) {
        var tbody = document.getElementById('one-piece-tbody');
        var statusEl = document.getElementById('one-piece-status');
        if (!tbody) return;

        tbody.innerHTML = '';

        var filtered = rows.filter(function (r) {
            return r && (r[0] || r[1]);
        });

        if (filtered.length === 0) {
            if (statusEl) statusEl.textContent = 'Keine Daten gefunden.';
            return;
        }

        if (filtered.length >= 3) {
            filtered = filtered.slice(2);
        }

        filtered.forEach(function (r) {
            var tr = document.createElement('tr');

            function tdWithText(txt) {
                var td = document.createElement('td');
                td.textContent = (txt || '').trim();
                return td;
            }

            tr.appendChild(tdWithText(r[0] || ''));
            tr.appendChild(tdWithText(r[1] || ''));
            tbody.appendChild(tr);
        });

        if (statusEl) statusEl.textContent = 'Letztes Update: live aus dem Sheet.';
    }

    function loadSheet() {
        var statusEl = document.getElementById('one-piece-status');
        if (statusEl) statusEl.textContent = 'Lade Daten...';

        fetch(CSV_URL)
            .then(function (res) {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.text();
            })
            .then(function (text) {
                var rows = parseCSV(text);
                renderRows(rows);
            })
            .catch(function () {
                if (statusEl) {
                    statusEl.textContent = 'Konnte das Sheet nicht laden. Ist es veroeffentlicht oder oeffentlich?';
                }
            });
    }

    loadSheet();
</script>
<script>
    function includeHTML() {
        var z, i, elmnt, file, xhttp;
        /* Loop through a collection of all HTML elements: */
        z = document.getElementsByTagName("*");
        for (i = 0; i < z.length; i++) {
            elmnt = z[i];
            /*search for elements with a certain atrribute:*/
            file = elmnt.getAttribute("w3-include-html");
            if (file) {
                /* Make an HTTP request using the attribute value as the file name: */
                xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4) {
                        if (this.status == 200) {elmnt.innerHTML = this.responseText;}
                        if (this.status == 404) {elmnt.innerHTML = "Page not found.";}
                        /* Remove the attribute, and call this function once more: */
                        elmnt.removeAttribute("w3-include-html");
                        includeHTML();
                    }
                }
                xhttp.open("GET", file, true);
                xhttp.send();
                /* Exit the function: */
                return;
            }
        }
    }
</script>
<script>
    includeHTML();
</script>
</body>
</html>
